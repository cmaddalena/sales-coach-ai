<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Sales Coach AI</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

  <!-- Header -->
  <header class="dashboard-header">
    <div class="logo">ü§ñ Sales Coach AI</div>
    <div class="user-menu">
      <span id="user-name">Usuario</span>
      <button id="logout-btn" onclick="logout()">Salir</button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="dashboard-main">
    
    <!-- Welcome Card -->
    <div class="welcome-card">
      <h1>Hola <span id="nombre-usuario">Usuario</span>! üëã</h1>
      <p id="tipo-negocio">Sistema comercial completo.</p>
    </div>
    
    <!-- Tabs Navigation -->
    <div class="tabs">
      <button class="tab active" onclick="showTab('overview')">üìä Overview</button>
      <button class="tab" onclick="showTab('coach')">üß† Tu Coach</button>
      <button class="tab" onclick="showTab('leads')">üë• Leads</button>
    </div>
    
    <!-- TAB: Overview -->
    <div id="tab-overview" class="tab-content active">
      
      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Objetivo Mes</h3>
          <p class="stat-value" id="objetivo-mensual">$0</p>
        </div>
        
        <div class="stat-card">
          <h3>Revenue Actual</h3>
          <p class="stat-value" id="revenue-actual">$0</p>
        </div>
        
        <div class="stat-card">
          <h3>Tiempo Disponible</h3>
          <p class="stat-value" id="tiempo-disponible">0h/sem</p>
        </div>
        
        <div class="stat-card">
          <h3>Leads Activos</h3>
          <p class="stat-value" id="leads-activos">0</p>
        </div>
      </div>
      
      <!-- Action Cards -->
      <div class="action-cards">
        <div class="action-card">
          <h3>üéØ Pr√≥ximas Acciones</h3>
          <p>Sistema en construcci√≥n...</p>
          <ul>
            <li>Morning Briefing autom√°tico</li>
            <li>Recomendaciones inteligentes</li>
            <li>Tracking leads</li>
            <li>Chat con IA contextual</li>
          </ul>
        </div>
        
        <div class="action-card">
          <h3>üìã Tu Perfil</h3>
          <p><strong>Nombre:</strong> <span id="perfil-nombre">-</span></p>
          <p><strong>Negocio:</strong> <span id="perfil-negocio">-</span></p>
          <p><strong>Pa√≠s:</strong> <span id="perfil-pais">-</span></p>
          <p><strong>Objetivo mensual:</strong> $<span id="perfil-objetivo">-</span></p>
          <p><strong>Tiempo disponible:</strong> <span id="perfil-tiempo">-</span>h/semana</p>
        </div>
      </div>
      
    </div>
    
    <!-- TAB: Coach -->
    <div id="tab-coach" class="tab-content">
      
      <!-- Frase del D√≠a -->
      <div class="coach-motivacion">
        <div class="quote-icon">üí™</div>
        <p id="frase-dia" class="frase">Cargando tu coach personal...</p>
      </div>
      
      <!-- Estado Actual -->
      <div class="coach-estado">
        <h3>üìà Tu momento:</h3>
        
        <div class="estado-grid">
          <div class="estado-item">
            <label>Energ√≠a</label>
            <div class="progress-bar">
              <div id="energia-bar" class="progress-fill" style="width: 0%"></div>
            </div>
            <span id="energia-text">7/10</span>
          </div>
          
          <div class="estado-item">
            <label>Motivaci√≥n</label>
            <div class="progress-bar">
              <div id="motivacion-bar" class="progress-fill" style="width: 0%"></div>
            </div>
            <span id="motivacion-text">7/10</span>
          </div>
          
          <div class="estado-item">
            <label>Progreso mes</label>
            <div class="progress-bar">
              <div id="progreso-bar" class="progress-fill" style="width: 0%"></div>
            </div>
            <span id="progreso-text">0%</span>
          </div>
        </div>
        
        <button onclick="reportarEstado()" class="btn-secondary">
          ¬øC√≥mo te sent√≠s hoy?
        </button>
      </div>
      
      <!-- Situaci√≥n + Plan -->
      <div class="coach-situacion">
        <h3 id="situacion-title">üéØ Analizando situaci√≥n...</h3>
        <p id="situacion-descripcion">Generando recomendaciones...</p>
      </div>
      
      <div class="coach-plan">
        <h3>üí° Qu√© hacer AHORA:</h3>
        <div id="plan-acciones">
          <p>Cargando plan personalizado...</p>
        </div>
      </div>
      
      <!-- Bot√≥n P√°nico -->
      <div class="coach-panico">
        <button onclick="activarModoCoach()" class="btn-panico">
          üÜò Necesito ayuda YA
        </button>
        <p class="panico-hint">Trigger chat IA modo "coach emocional"</p>
      </div>
      
    </div>
    
    <!-- TAB: Leads -->
    <div id="tab-leads" class="tab-content">
      <!-- REPLACE: Tab Leads content (buscar y reemplazar el bloque mock actual) -->
<div id="leads-tab-content" style="padding: 20px;">
  
  <!-- Header con filtros y bot√≥n agregar -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
    
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <button onclick="filtrarLeads('todos')" id="filter-todos" class="filter-btn active" style="padding: 8px 16px; border: 2px solid #6366f1; background: #6366f1; color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">
        Todos
      </button>
      <button onclick="filtrarLeads('caliente')" id="filter-caliente" class="filter-btn" style="padding: 8px 16px; border: 2px solid #ef4444; background: white; color: #ef4444; border-radius: 8px; cursor: pointer; font-weight: 600;">
        üî• Calientes
      </button>
      <button onclick="filtrarLeads('tibio')" id="filter-tibio" class="filter-btn" style="padding: 8px 16px; border: 2px solid #f59e0b; background: white; color: #f59e0b; border-radius: 8px; cursor: pointer; font-weight: 600;">
        üå°Ô∏è Tibios
      </button>
      <button onclick="filtrarLeads('frio')" id="filter-frio" class="filter-btn" style="padding: 8px 16px; border: 2px solid #3b82f6; background: white; color: #3b82f6; border-radius: 8px; cursor: pointer; font-weight: 600;">
        ‚ùÑÔ∏è Fr√≠os
      </button>
    </div>
    
    <button onclick="abrirModalAgregarLead()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">
      + Agregar Lead
    </button>
  </div>
  
  <!-- Listado de leads -->
  <div id="leads-list-container" style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 20px; min-height: 300px;">
    <p style="color: #666; text-align: center;">Cargando leads...</p>
  </div>
  
</div>

<!-- Modal para agregar lead -->
<div id="modal-agregar-lead" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
  <div style="background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
    <h2 style="margin-bottom: 20px; color: #333;">Agregar Nuevo Lead</h2>
    
    <form id="form-agregar-lead" onsubmit="guardarNuevoLead(event)" style="display: flex; flex-direction: column; gap: 15px;">
      
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Nombre *</label>
        <input type="text" id="lead-nombre" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Empresa</label>
        <input type="text" id="lead-empresa" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Tel√©fono</label>
        <input type="tel" id="lead-telefono" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Email</label>
        <input type="email" id="lead-email" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Temperatura *</label>
        <select id="lead-temperatura" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
          <option value="caliente">üî• Caliente</option>
          <option value="tibio" selected>üå°Ô∏è Tibio</option>
          <option value="frio">‚ùÑÔ∏è Fr√≠o</option>
        </select>
      </div>
      
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Tipo</label>
        <select id="lead-tipo" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
          <option value="lead" selected>Lead</option>
          <option value="cliente">Cliente</option>
          <option value="partner">Partner</option>
          <option value="contacto">Contacto</option>
        </select>
      </div>
      
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Notas</label>
        <textarea id="lead-notas" rows="3" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button type="submit" style="flex: 1; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">
          Guardar
        </button>
        <button type="button" onclick="cerrarModalAgregarLead()" style="flex: 1; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">
          Cancelar
        </button>
      </div>
      
    </form>
  </div>
</div>

<style>
  .filter-btn.active {
    background: #6366f1 !important;
    color: white !important;
  }
  
  .filter-btn:hover {
    opacity: 0.8;
  }
</style>
<!-- END REPLACE -->
    </div>
    
  </main>

  <!-- Styles -->
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
    
    .dashboard-header {
      background: white;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .logo { font-size: 24px; font-weight: bold; }
    
    .user-menu {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    #logout-btn {
      background: #f0f0f0;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .dashboard-main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    .welcome-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px;
      border-radius: 12px;
      margin-bottom: 30px;
    }
    
    .welcome-card h1 { margin-bottom: 10px; }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      background: white;
      padding: 10px;
      border-radius: 12px;
    }
    
    .tab {
      flex: 1;
      padding: 15px;
      background: transparent;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .tab:hover { background: #f0f0f0; }
    .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
    }
    
    /* Action Cards */
    .action-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .action-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .action-card h3 { margin-bottom: 15px; }
    .action-card ul { padding-left: 20px; margin-top: 10px; }
    .action-card li { margin: 8px 0; }
    
    /* Coach Styles */
    .coach-motivacion {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .quote-icon { font-size: 48px; margin-bottom: 15px; }
    .frase { font-size: 20px; line-height: 1.6; font-style: italic; }
    
    .coach-estado, .coach-situacion, .coach-plan, .coach-panico {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .estado-grid { display: grid; gap: 20px; margin-bottom: 20px; }
    .estado-item label { display: block; font-size: 14px; color: #666; margin-bottom: 8px; }
    
    .progress-bar {
      width: 100%;
      height: 12px;
      background: #f0f0f0;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 5px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
    }
    
    .btn-secondary, .btn-panico {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
      width: 100%;
    }
    
    .btn-panico {
      background: #ff4444;
      color: white;
      font-size: 18px;
      padding: 20px 40px;
      box-shadow: 0 4px 12px rgba(255,68,68,0.3);
    }
    
    .coach-panico { text-align: center; padding: 40px 25px; }
    .panico-hint { margin-top: 10px; font-size: 12px; color: #999; }
    
    .coming-soon {
      background: white;
      padding: 60px;
      border-radius: 12px;
      text-align: center;
    }
    
    .coming-soon h2 { margin-bottom: 20px; }
  </style>

  <!-- Scripts -->
  <script>
  // ============================================================
  // INICIALIZACI√ìN Y VARIABLES GLOBALES
  // ============================================================
  let supabase;
  let currentUser = null;
  let userProfile = null;

  // ============================================================
  // FUNCI√ìN: Inicializar Supabase y verificar autenticaci√≥n
  // ============================================================
  async function initDashboard() {
    try {
      // Cargar Supabase
      if (!window.supabase) {
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.js';
        await new Promise(resolve => {
          script.onload = resolve;
          document.head.appendChild(script);
        });
      }
      
      const createClient = window.supabase.createClient;
      supabase = createClient(
        "https://vrauyvcwmgqlbqrnkngx.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZyYXV5dmN3bWdxbGJxcm5rbmd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTY5NTgsImV4cCI6MjA4MDU5Mjk1OH0.5RwraVx_nOWFrVfrT851q8SL475DuTvJS6Mep1GK8Rk"
      );
      
      // Verificar si hay usuario logueado
      const { data: { user }, error } = await supabase.auth.getUser();
      
      if (error || !user) {
        console.log('No hay usuario logueado, redirigiendo...');
        window.location.href = '/auth.html';
        return;
      }
      
      currentUser = user;
      localStorage.setItem('userId', user.id);
      
      // Cargar perfil del usuario
      await loadUserProfile(user.id);
      
      // Cargar contenido del dashboard
      loadDashboardContent();
      
    } catch (error) {
      console.error('Error inicializando dashboard:', error);
      window.location.href = '/auth.html';
    }
  }

  // ============================================================
  // FUNCI√ìN: Cargar perfil del usuario
  // ============================================================
  async function loadUserProfile(userId) {
    try {
      const response = await fetch(`/api/user-profile?userId=${userId}`);
      const data = await response.json();
      
      if (data.profile) {
        userProfile = data.profile;
        displayUserProfile();
      } else {
        console.log('No se encontr√≥ perfil, redirigiendo a wizard...');
        window.location.href = '/wizard.html';
      }
    } catch (error) {
      console.error('Error cargando perfil:', error);
    }
  }

  // ============================================================
  // FUNCI√ìN: Mostrar datos del perfil en el dashboard
  // ============================================================
  function displayUserProfile() {
    if (!userProfile) return;
    
    // Actualizar saludo
    const saludoElement = document.querySelector('h1, .greeting, [id*="saludo"]');
    if (saludoElement) {
      saludoElement.textContent = `Hola ${userProfile.nombre || 'Usuario'}! üëã`;
    }
    
    // Actualizar descripci√≥n de negocio
    const descripcionElement = document.querySelector('.tagline, .description, [id*="descripcion"]');
    if (descripcionElement) {
      descripcionElement.textContent = userProfile.tipo_negocio || 'Sistema comercial completo.';
    }
    
    // Actualizar m√©tricas del overview
    updateMetricas();
    
    // Actualizar "Tu Perfil"
    updatePerfilSection();
  }

  // ============================================================
  // FUNCI√ìN: Actualizar m√©tricas del overview
  // ============================================================
  function updateMetricas() {
    // Objetivo Mensual
    const objetivoElement = document.getElementById('objetivo-mensual') || 
                            document.querySelector('[data-metric="objetivo"]');
    if (objetivoElement) {
      const objetivo = userProfile.objetivo_revenue_mensual || 0;
      objetivoElement.textContent = `$${objetivo.toLocaleString()}`;
    }
    
    // Revenue Actual
    const revenueElement = document.getElementById('revenue-actual') || 
                           document.querySelector('[data-metric="revenue"]');
    if (revenueElement) {
      revenueElement.textContent = `$0`;
    }
    
    // Tiempo Disponible
    const tiempoElement = document.getElementById('tiempo-disponible') || 
                          document.querySelector('[data-metric="tiempo"]');
    if (tiempoElement) {
      const horas = userProfile.horas_semana_ventas || 40;
      tiempoElement.textContent = `${horas}h/sem`;
    }
    
    // Leads Activos
    const leadsElement = document.getElementById('leads-activos') || 
                         document.querySelector('[data-metric="leads"]');
    if (leadsElement) {
      leadsElement.textContent = `0`;
    }
  }

  // ============================================================
  // FUNCI√ìN: Actualizar secci√≥n "Tu Perfil"
  // ============================================================
  function updatePerfilSection() {
    // Buscar el contenedor de Tu Perfil
    const perfilSection = document.querySelector('[id*="perfil"]') || 
                          document.querySelector('.perfil-container');
    
    if (!perfilSection) return;
    
    // Actualizar o crear elementos de perfil
    const datos = [
      { label: 'Nombre', value: userProfile.nombre || '-', key: 'nombre' },
      { label: 'Negocio', value: userProfile.tipo_negocio || '-', key: 'negocio' },
      { label: 'Pa√≠s', value: userProfile.pais || '-', key: 'pais' },
      { label: 'Objetivo mensual', value: `$${(userProfile.objetivo_revenue_mensual || 0).toLocaleString()}`, key: 'objetivo' },
      { label: 'Tiempo disponible', value: `${userProfile.horas_semana_ventas || 0}h/semana`, key: 'tiempo' }
    ];
    
    datos.forEach(dato => {
      let element = perfilSection.querySelector(`[data-profile="${dato.key}"]`);
      if (element) {
        element.textContent = dato.value;
      }
    });
  }

  // ============================================================
  // FUNCI√ìN: Cargar contenido del dashboard seg√∫n tab activa
  // ============================================================
  function loadDashboardContent() {
    // Si hay funci√≥n cargarLeads y la tab Leads est√° activa, ejecutarla
    const leadsTab = document.querySelector('[data-tab="leads"], #leads-tab, .tab-leads');
    if (leadsTab && leadsTab.classList.contains('active') && typeof cargarLeads === 'function') {
      cargarLeads();
    }
  }

  // ============================================================
  // FUNCI√ìN: getUserId (helper mejorado)
  // ============================================================
  function getUserId() {
    // Prioridad 1: currentUser (ya verificado por autenticaci√≥n)
    if (currentUser) {
      return currentUser.id;
    }
    
    // Prioridad 2: localStorage directo
    let userId = localStorage.getItem('userId');
    if (userId) {
      return userId;
    }
    
    // Prioridad 3: sales_coach_state
    const state = localStorage.getItem('sales_coach_state');
    if (state) {
      try {
        const parsed = JSON.parse(state);
        userId = parsed.user_id;
        if (userId) return userId;
      } catch (e) {
        console.error('Error parsing sales_coach_state:', e);
      }
    }
    
    return null;
  }

  // ============================================================
  // FUNCI√ìN: Logout
  // ============================================================
  async function logout() {
    try {
      if (supabase) {
        await supabase.auth.signOut();
      }
    } catch (error) {
      console.error('Error al cerrar sesi√≥n:', error);
    }
    
    localStorage.clear();
    window.location.href = '/index.html';
  }

  // ============================================================
  // INICIALIZAR AL CARGAR LA P√ÅGINA
  // ============================================================
  window.addEventListener('DOMContentLoaded', initDashboard);
</script>
  

  <!-- APPEND: JavaScript for Leads management -->
<script>
  // ============================================================
  // VARIABLES GLOBALES PARA LEADS
  // ============================================================
  let todosLosLeads = [];
  let filtroActual = 'todos';

  // ============================================================
  // CARGAR LEADS DESDE API
  // ============================================================
  async function cargarLeads() {
    try {
      const userId = getUserId();
      
      if (!userId) {
        console.log('No userId found');
        document.getElementById('leads-list-container').innerHTML = 
          '<p style="color: #999; text-align: center;">No se pudo cargar el usuario</p>';
        return;
      }
      
      const response = await fetch(`/api/contactos?userId=${encodeURIComponent(userId)}`);
      if (!response.ok) throw new Error('Error fetching contactos');
      const { contactos } = await response.json();
      
      todosLosLeads = contactos || [];
      mostrarLeads(todosLosLeads);
      
    } catch (error) {
      console.error('Error cargando leads:', error);
      const container = document.getElementById('leads-list-container');
      if (container) {
        container.innerHTML = 
          '<p style="color: #ef4444; text-align: center;">Error cargando leads</p>';
      }
    }
  }

  // ============================================================
  // MOSTRAR LEADS EN LA LISTA
  // ============================================================
  function mostrarLeads(leads) {
    const container = document.getElementById('leads-list-container');
    if (!container) return;
    
    if (!leads || leads.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <p style="font-size: 48px; margin-bottom: 10px;">üìã</p>
          <p style="color: #999; font-size: 18px;">No hay leads registrados</p>
          <button onclick="abrirModalAgregarLead()" style="margin-top: 20px; padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
            + Agregar tu primer lead
          </button>
        </div>
      `;
      return;
    }
    
    const ahora = new Date();
    
    container.innerHTML = leads.map(lead => {
      const diasSinContacto = lead.ultima_interaccion 
        ? Math.floor((ahora - new Date(lead.ultima_interaccion)) / (1000 * 60 * 60 * 24))
        : '‚àû';
      
      const colores = {
        caliente: { border: '#ef4444', bg: '#fff8f8', emoji: 'üî•' },
        tibio: { border: '#f59e0b', bg: '#fffbf0', emoji: 'üå°Ô∏è' },
        frio: { border: '#3b82f6', bg: '#f0f9ff', emoji: '‚ùÑÔ∏è' }
      };
      
      const color = colores[lead.temperatura] || colores.frio;
      
      return `
        <div style="border-left: 4px solid ${color.border}; background: ${color.bg}; padding: 15px; margin-bottom: 12px; border-radius: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px;">
            
            <div style="flex: 1; min-width: 200px;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: 20px;">${color.emoji}</span>
                <strong style="font-size: 18px; color: #333;">${lead.nombre}</strong>
              </div>
              
              ${lead.empresa ? `<p style="color: #666; margin-bottom: 4px;">üè¢ ${lead.empresa}</p>` : ''}
              ${lead.telefono ? `<p style="color: #666; margin-bottom: 4px;">üìû ${lead.telefono}</p>` : ''}
              ${lead.email ? `<p style="color: #666; margin-bottom: 4px;">üìß ${lead.email}</p>` : ''}
              
              <p style="color: #999; font-size: 14px; margin-top: 8px;">
                √öltima interacci√≥n: ${diasSinContacto === '‚àû' ? 'Nunca' : `hace ${diasSinContacto} d√≠as`}
              </p>
              
              ${lead.notas ? `<p style="color: #666; font-size: 14px; margin-top: 8px; font-style: italic;">"${lead.notas}"</p>` : ''}
            </div>
            
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button onclick="contactarLead('${lead.id}')" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                üìû Contactar
              </button>
              <button onclick="eliminarLead('${lead.id}')" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                üóëÔ∏è
              </button>
            </div>
            
          </div>
        </div>
      `;
    }).join('');
  }

  // ============================================================
  // FILTRAR LEADS
  // ============================================================
  function filtrarLeads(temperatura) {
    filtroActual = temperatura;
    
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    const el = document.getElementById(`filter-${temperatura}`);
    if (el) el.classList.add('active');
    
    if (temperatura === 'todos') {
      mostrarLeads(todosLosLeads);
    } else {
      const leadsFiltrados = todosLosLeads.filter(lead => lead.temperatura === temperatura);
      mostrarLeads(leadsFiltrados);
    }
  }

  // ============================================================
  // MODAL AGREGAR LEAD
  // ============================================================
  function abrirModalAgregarLead() {
    const modal = document.getElementById('modal-agregar-lead');
    if (modal) {
      modal.style.display = 'flex';
      const form = document.getElementById('form-agregar-lead');
      if (form) form.reset();
    }
  }

  function cerrarModalAgregarLead() {
    const modal = document.getElementById('modal-agregar-lead');
    if (modal) modal.style.display = 'none';
  }

  // ============================================================
  // GUARDAR NUEVO LEAD
  // ============================================================
  async function guardarNuevoLead(event) {
    event.preventDefault();
    
    const userId = getUserId();
    
    if (!userId) {
      alert('Error: No se pudo identificar el usuario');
      return;
    }
    
    const nuevoLead = {
      user_id: userId,
      nombre: document.getElementById('lead-nombre').value,
      empresa: document.getElementById('lead-empresa').value || null,
      telefono: document.getElementById('lead-telefono').value || null,
      email: document.getElementById('lead-email').value || null,
      temperatura: document.getElementById('lead-temperatura').value,
      tipo: document.getElementById('lead-tipo').value,
      notas: document.getElementById('lead-notas').value || null
    };
    
    try {
      const response = await fetch('/api/contactos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(nuevoLead)
      });
      
      if (!response.ok) throw new Error('Error al guardar');
      
      cerrarModalAgregarLead();
      await cargarLeads();
      alert('‚úÖ Lead agregado exitosamente');
      
    } catch (error) {
      console.error('Error guardando lead:', error);
      alert('‚ùå Error al guardar el lead');
    }
  }

  // ============================================================
  // CONTACTAR LEAD
  // ============================================================
  function contactarLead(leadId) {
    alert(`Contactar lead ${leadId}\n\nPr√≥ximamente:\n- Registrar llamada/email\n- Actualizar √∫ltima interacci√≥n\n- Agregar nota de seguimiento`);
  }

  // ============================================================
  // ELIMINAR LEAD
  // ============================================================
  async function eliminarLead(leadId) {
    if (!confirm('¬øEst√°s seguro de eliminar este lead?')) return;
    
    try {
      const response = await fetch(`/api/contactos?id=${encodeURIComponent(leadId)}`, {
        method: 'DELETE'
      });
      
      if (!response.ok) throw new Error('Error al eliminar');
      
      await cargarLeads();
      alert('‚úÖ Lead eliminado');
      
    } catch (error) {
      console.error('Error eliminando lead:', error);
      alert('‚ùå Error al eliminar el lead');
    }
  }

  // ============================================================
  // INICIALIZAR CUANDO SE MUESTRA LA TAB LEADS
  // ============================================================
  // Llamar cargarLeads() cuando se active la tab Leads en tu sistema de tabs.
  // Si tienes una funci√≥n showTab(tabId) agrega: if(tabId==='leads'){ cargarLeads(); }
  // Si la tab Leads se muestra por defecto, invoca cargarLeads() aqu√≠:
  // cargarLeads();
</script>
<!-- END APPEND -->

</body>
</html>
